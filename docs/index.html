<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPL PAY</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #141618;
            color: white;
            margin: 0;
            padding: 0;
			overflow: hidden;
        }
        .snowflake {
            position: absolute;
            top: -10%;
            color: rgba(255,255,255,0.1);;
            font-size: 1em;
            pointer-events: none;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% {
                transform: translateY(80px);
            }
            100% {
				font-size: 0px;
                transform: translateY(100vh);
            }
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #24282b;
        }
        .header .logo {
            display: flex;
            align-items: center;
        }
        .header .logo img {
            width: 40px;
            margin-right: 10px;
        }
        .header .user-info {
            display: flex;
            align-items: center;
        }
        .header .user-info button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            background-color: #4dbfa1;
            color: black;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header .user-info button:hover {
            background-color: #31363b;
            color: white;
        }
        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 50px 0;
        }
        .balance {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .balance img {
            width: 40px;
            margin-right: 10px;
        }
        .balance .amount {
            font-size: 24px;
        }
        .buttons {
            display: flex;
            gap: 20px;
        }
        .buttons button {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            background-color: #24282b;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .buttons button:hover {
            background-color: #4dbfa1;
            color: black;
        }
        .buttons button.frozen:hover {
            background-color: #e6605e;
        }
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #24282b;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .footer .support {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            background-color: #4dbfa1;
            color: black;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .footer .support:hover {
            background-color: #31363b;
            color: white;
        }
		.modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
    .modal-content {
        background-color: #24282b;
        margin: 15% auto;
        padding: 20px;
        border-radius: 15px;
        width: 80%;
        max-width: 500px;
        box-sizing: border-box;
    }
	    .modal-content .close {
            color: #4dbfa1;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content .close:hover {
            color: #31363b;
        }
    .modal-content h2 {
        margin-bottom: 20px;
        color: white;
    }
    .modal-content .form-group {
        margin-bottom: 15px;
    }
    .modal-content .form-group label {
        display: block;
        margin-bottom: 5px;
        color: rgba(255,255,255,0.5);
    }
    .modal-content .form-group input {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 15px;
        background-color: #31363b;
        color: white;
        box-sizing: border-box;
    }
		.modal-content .form-group input[type="submit"] {
			padding: 15px 30px;
            border: none;
            border-radius: 15px;
            background-color: #31363b;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
		}
		.modal-content .form-group input[type="submit"]:hover {
			background-color: #4dbfa1;
			color: black;
		}
		.modal-content .message {
            text-align: center;
            margin-top: 20px;
        }
        .modal-content .message img {
            width: 100px;
            margin-bottom: 10px;
        }
		.modal-content button {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            background-color: #31363b;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
		.modal-content button:hover {
            background-color: #4dbfa1;
            color: black;
        }
		.history-table {
            width: 100%;
            border-collapse: collapse;
			border-spacing: 0; /* Убираем отступы между ячейками */
            margin-top: 20px;
			border: 1px solid #ddd; /* Граница таблицы */
			border-radius: 15px; /* Скругление углов всей таблицы */
			overflow: hidden; /* Скрытие границ, выходящих за пределы скругления */
        }
        .history-table th, .history-table td {
            padding: 10px;
            text-align: left;
            color: white;
			background-color: #31363b;
        }
        .history-table th {
            background-color: #4dbfa1;
            color: black;
        }
    </style>
    <link rel="icon" type="image/svg" href="/pepeland.svg">
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="/pepeland.svg" alt="PPL PAY">
            <span>PPL PAY</span>
        </div>
        <div class="user-info">
            <span id="username">Username</span>
            <button id="login-logout">Войти</button>
        </div>
    </div>
    <div class="content">
        <div class="balance">
            <img src="https://minecraft.wiki/images/thumb/Diamond_%28inventory%29_MCE.png/160px-Diamond_%28inventory%29_MCE.png?739b2" alt="Diamond">
            <span class="amount" id="balance">0</span>
        </div>
		<div class="frozen-message" id="frozen-message" style="display: none;">
            Аккаунт заморожен. Разблокировать его можно в отделении банка.<br></br>
        </div>
        <div class="buttons">
            <button id="send-money">Отправить деньги</button>
            <button id="freeze-account" class="frozen">Заморозить аккаунт</button>
            <button id="transaction-history">История операций</button>
        </div>
    </div>
    <div class="footer">
        <button class="support" id="contactSupport">Тех. поддержка</button>
        <span>Copyright (C) 2024 ItzKITb</span>
    </div>

	<!-- Modal for transaction history -->
    <div id="transactionHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
			<div class="message">
				<img src="https://img.icons8.com/?size=100&id=kNAXzKcSNxtX&format=png&color=000000" alt="Success">
				<h2>История операций</h2>
			</div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Кому</th>
                        <th>От кого</th>
                        <th>Дата</th>
                        <th>Сумма</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Данные будут добавлены динамически с помощью JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

<!-- Modal for login -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
		<div class="message">
			<img src="https://img.icons8.com/?size=100&id=U5AcCk9kUWMk&format=png&color=000000" alt="Success">
			<h2>Вход в систему</h2>
		</div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Имя пользователя:</label>
                <input type="text" id="login-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль:</label>
                <input type="password" id="login-password" name="password" required>
            </div>
            <div class="form-group">
                <input type="submit" value="Войти">
            </div>
        </form>
    </div>
</div>

<!-- Modal for send money -->
<div id="sendMoneyModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
		<div class="message">
			<img src="https://img.icons8.com/?size=100&id=QZ9F32rYuMF4&format=png&color=000000" alt="Success">
			<h2>Отправить деньги</h2>
		</div>
		<form id="sendMoneyForm">
			<div class="form-group">
				<label for="toUsername">Кому (Никнейм):</label>
				<input type="text" id="toUsername" name="toUsername" required>
			</div>
			<div class="form-group">
				<label for="amount">Сколько:</label>
				<input type="number" id="amount" name="amount" required>
			</div>
			<div class="form-group">
				<input type="submit" value="Отправить">
			</div>
		</form>
    </div>
</div>

<!-- Modal for success message -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="message">
            <img src="https://img.icons8.com/?size=100&id=pIPl8tqh3igN&format=png&color=000000" alt="Success">
            <h2>Успешно</h2>
			<p>Операция проведена успешно!</p>
            <button id="backToMain">На главную</button>
        </div>
    </div>
</div>

<!-- Modal for error message -->
<div id="errorModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="message">
            <img src="https://img.icons8.com/?size=100&id=fYgQxDaH069W&format=png&color=000000" alt="Error">
            <h2>Операция не удалась</h2>
			<p id="errorReason">Ошибка: -</p>
            <button id="contactSupport">Обратиться в тех. поддержку</button>
        </div>
    </div>
</div>

<!-- Modal for loading message -->
<div id="loadingModal" class="modal">
    <div class="modal-content">
		<span class="close">&times;</span>
		<div class="message">
			<img src="https://cdn.7tv.app/emote/01F85DPWW000087K31WRSHV0E1/4x.webp" alt="Success">
			<h2>Загрузка...</h2>
			<p>Это может занять примерно 30 секунд</p>
			<button id="contactSupportLoading">Прошло больше минуты? Обратиться в тех. поддержку</button>
		</div>
    </div>
</div>

<!-- Modal for freeze message -->
<div id="freezeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="message">
            <img src="https://img.icons8.com/?size=100&id=JBQOSn7KOSuD&format=png&color=000000" alt="Success">
            <p>Вы уверены, что хотите заморозить свой счет?</p>
            <button id="freezeAccounAcceptButton">Да. Я понимаю, что делаю</button>
        </div>
    </div>
</div>

    <script>
    const loginModal = document.getElementById('loginModal');
    const sendMoneyModal = document.getElementById('sendMoneyModal');
    const successModal = document.getElementById('successModal');
    const errorModal = document.getElementById('errorModal');
    const loadingModal = document.getElementById('loadingModal');
	const freezeModal = document.getElementById('freezeModal');
    const usernameElement = document.getElementById('username');
    const balanceElement = document.getElementById('balance');
    const loginLogoutButton = document.getElementById('login-logout');
    const sendMoneyButton = document.getElementById('send-money');
    const freezeAccountButton = document.getElementById('freeze-account');
    const transactionHistoryButton = document.getElementById('transaction-history');
    const backToMainButton = document.getElementById('backToMain');
    const contactSupportButton = document.getElementById('contactSupport');
    const contactSupportLoadingButton = document.getElementById('contactSupportLoading');
	const freezeModalButton = document.getElementById('freezeAccounAcceptButton');
	const historyBody = document.getElementById('historyBody');
	const modalHistory = document.getElementById('transactionHistoryModal');
	const errorReason = document.getElementById('errorReason');
	const accountFrozenText = document.getElementById('frozen-message');
	
	let userCache = {};
    let loggedInUser = null;
	let firstStart = true;
	let isLoggedIn = false;
	let currentlyGettingBalance = false;
	
	let isAccountFrozen = false;

        // Функция для создания снежинок
	function createSnowflake() {
		if (isAccountFrozen)
		{
			accountFrozenText.style.display = 'block';
			sendMoneyButton.style.display = 'none';
			freezeAccountButton.style.display = 'none';
			const snowflake = document.createElement('div');
			snowflake.className = 'snowflake';
			snowflake.innerHTML = '❄';
			snowflake.style.left = Math.random() * 100 + 'vw';
			const animationDuration = (Math.random() * 3 + 2);
			snowflake.style.animationDuration = animationDuration + 's';
			snowflake.style.fontSize = (Math.random() * 2 + 1) + 'em';
			document.body.appendChild(snowflake);

			setTimeout(() => {
				snowflake.remove();
			}, animationDuration * 1000);
		}
		else
		{
			accountFrozenText.style.display = 'none';
			sendMoneyButton.style.display = 'block';
			freezeAccountButton.style.display = 'block';
		}
	}

		setInterval(createSnowflake, 500);
		
		document.addEventListener('DOMContentLoaded', async function() {
			const savedUsername = localStorage.getItem('username');
			const savedPassword = localStorage.getItem('password');
			
			if (savedUsername != null && savedPassword != null) {
				isLoggedIn = true;
				loggedInUser = { username: savedUsername, password: savedPassword };
				usernameElement.textContent = savedUsername;
                showBalance();
                loginLogoutButton.textContent = 'Выйти';
                loginLogoutButton.onclick = logout;
				isAccountFrozen = await GetUserFrezeeStatus();
				console.log(isAccountFrozen);
			}
			else
			{
				openModal(loginModal);
			}
		});
		
        function openModal(modal) {
            modal.style.display = 'block';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
        }

        function showBalance() {
			if (!currentlyGettingBalance)
			{
				currentlyGettingBalance = true;
				if (firstStart)
				{
					openModal(loadingModal);
				}
				fetch('https://bank-yg2e.onrender.com/balance', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						"username": loggedInUser.username,
						"password": loggedInUser.password
					})
				})
				.then(response => {
					if (response.ok) {
						return response.json();
					} else if (response.status === 401) {
						throw new Error('Неверный логин или пароль');
					} else {
						throw new Error('Ошибка сервера');
					}
				})
				.then(data => {
					balanceElement.textContent = data.balance;
					if (firstStart)
					{
						closeModal(loadingModal);
						firstStart = false;
					}
					currentlyGettingBalance = false;
				})
				.catch(error => {
					console.error(error);
					errorReason.textContent = error;
					openModal(errorModal);
				});
			}
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
			
			console.log("Logging...");
			openModal(loadingModal);
			
            fetch('https://bank-yg2e.onrender.com/balance', {
                method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
                body: JSON.stringify({
                    "username": username,
                    "password": password
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 401) {
                    throw new Error('Неверный логин или пароль');
                } else {
                    throw new Error('Ошибка сервера');
                }
            })
            .then(data => {
				isLoggedIn = true;
				localStorage.setItem('username', username);
				localStorage.setItem('password', password);
                loggedInUser = { username: username, password: password };
                usernameElement.textContent = username;
                balanceElement.textContent = data.balance;
                loginLogoutButton.textContent = 'Выйти';
                loginLogoutButton.onclick = logout;
				closeModal(loadingModal);
                closeModal(loginModal);
				freezeStartusUpdate();
            })
            .catch(error => {
                console.error(error);
				errorReason.textContent = error;
				closeModal(loadingModal);
                openModal(errorModal);
            });
        }

        function sendMoney() {
            const toUsername = document.getElementById('toUsername').value;
            const amount = parseInt(document.getElementById('amount').value, 10);

            openModal(loadingModal);

            fetch('https://bank-yg2e.onrender.com/transfer', {
                method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
                body: JSON.stringify({
                    "fromUsername": loggedInUser.username,
                    "fromPassword": loggedInUser.password,
                    "toUsername": toUsername,
                    "amount": amount
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 400) {
                    throw new Error('Недостаточно средств');
                } else if (response.status === 403) {
                    throw new Error('Один и аккаунтов операции заморожен');
                } else if (response.status === 404) {
                    throw new Error('Пользователь не найден');
				} else if (response.status === 418) {
                    throw new Error('Вы не можете отправить самому себе!');
                } else {
                    throw new Error('Ошибка сервера');
                }
            })
            .then(data => {
                openModal(successModal);
                closeModal(loadingModal);
                showBalance();
            })
            .catch(error => {
                console.error(error);
				errorReason.textContent = error.message;
                openModal(errorModal);
                closeModal(loadingModal);
            });
        }

        function freezeAccount() {
            fetch('https://bank-yg2e.onrender.com/freeze', {
                method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
                body: JSON.stringify({
                    "username": loggedInUser.username,
                    "password": loggedInUser.password
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    throw new Error('Пользователь не найден');
                } else {
                    throw new Error('Ошибка сервера');
                }
            })
            .then(data => {
                alert('Аккаунт теперь заморожен! Для разблокировки обращайтесь в отделение банка');
				isAccountFrozen = true;
            })
            .catch(error => {
                console.error(error);
				errorReason.textContent = error;
                openModal(errorModal);
            });
        }

        function logout() {
			isAccountFrozen = false;
			localStorage.removeItem('username');
			localStorage.removeItem('password');
            loggedInUser = null;
            usernameElement.textContent = 'Username';
            balanceElement.textContent = '0';
            loginLogoutButton.textContent = 'Войти';
            loginLogoutButton.onclick = function() {
                openModal(loginModal);
            };
            openModal(loginModal);
        }

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            login();
        });

        document.getElementById('sendMoneyForm').addEventListener('submit', function(event) {
            event.preventDefault();
            sendMoney();
        });

        loginLogoutButton.addEventListener('click', function() {
            if (loggedInUser) {
                logout();
            } else {
                openModal(loginModal);
            }
        });

        sendMoneyButton.addEventListener('click', function() {
            openModal(sendMoneyModal);
        });

		freezeAccountButton.addEventListener('click', function() {
            openModal(freezeModal);
        });
		freezeModalButton.addEventListener('click', freezeAccount);
        transactionHistoryButton.addEventListener('click', openTransactionHistory);
        backToMainButton.addEventListener('click', function() {
            closeModal(successModal);
        });

        contactSupportButton.addEventListener('click', function() {
			window.open('mailto:itzkitb@gmail.com');
            closeModal(errorModal);
        });

        contactSupportLoadingButton.addEventListener('click', function() {
            window.open('mailto:itzkitb@gmail.com');
            closeModal(loadingModal);
        });
		contactSupportLoadingButton.addEventListener('click', function() {
            alert('Обратитесь в тех. поддержку');
            closeModal(loadingModal);
        });
        document.querySelectorAll('.close').forEach(closeButton => {
            closeButton.addEventListener('click', function() {
                const modal = this.closest('.modal');
                closeModal(modal);
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
		
		async function freezeStartusUpdate()
		{
			isAccountFrozen = await GetUserFrezeeStatus();
		}
		
		async function GetUserFrezeeStatus() {
			try {
				const response = await fetch('https://bank-yg2e.onrender.com/userInfoByUsername', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ username: loggedInUser.username })
				});
				if (response.ok) {
					const userInfo = await response.json();
					return userInfo.is_frozen;
				} else {
					throw new Error('Invalid userID');
				}
			} catch (error) {
				console.error(error);
				return false;
			}
		}
		
		function openTransactionHistory() {
			openModal(loadingModal);
            fetch('https://bank-yg2e.onrender.com/transaction-history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: loggedInUser.username,
                    password: loggedInUser.password
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 401) {
                    throw new Error('Неверный логин или пароль');
                } else {
                    throw new Error('Ошибка сервера');
                }
            })
            .then(data => {
                populateTransactionHistory(data);
            })
            .catch(error => {
                console.error(error);
                openModal(errorModal);
            });
        }

        async function populateTransactionHistory(transactions) {
			historyBody.innerHTML = '';

            for (const transaction of transactions) {
                const fromUserId = transaction.from_user_id;
                const toUserId = transaction.to_user_id;
				
                if (!userCache[fromUserId]) {
					try {
						const response = await fetch('https://bank-yg2e.onrender.com/userInfo', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ id: fromUserId })
						});
			
						if (response.ok) {
							const userInfo = await response.json();
							userCache[fromUserId] = userInfo.username;
						} else {
							throw new Error('Invalid userID');
						}
					} catch (error) {
						console.error(error);
						userCache[fromUserId] = '[НЕТ ИНФОРМАЦИИ]';
					}
                }

                if (!userCache[toUserId]) {
					try {
						const response = await fetch('https://bank-yg2e.onrender.com/userInfo', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ id: toUserId })
						});
			
						if (response.ok) {
							const userInfo = await response.json();
							userCache[toUserId] = userInfo.username;
						} else {
							throw new Error('Invalid userID');
						}
					} catch (error) {
						console.error(error);
						userCache[toUserId] = '[НЕТ ИНФОРМАЦИИ]';
					}
                }
				
                const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userCache[toUserId] || 'Загрузка...'}</td>
                        <td>${userCache[fromUserId] || 'Загрузка...'}</td>
                        <td>${new Date(transaction.created_at).toLocaleString()}</td>
                        <td>${transaction.amount}</td>
                    `;
                historyBody.appendChild(row);
            }
			
			closeModal(loadingModal);
            openModal(modalHistory);
		}
    </script>
</body>
</html>
